---
title: Zerotier的网络实现：NAT以及杂谈
tags: 云控制系统
pageview: false
modify_date: 2024-10-13
aside:
  toc: true
---

# Zerotier的网络实现：NAT以及杂谈

想让UDP能在NAT语境下使用，NAT路由器需要实现所谓的“UDP连接”。使用的技术就是NAT打洞。

## NAT打洞

做法是：让NAT监听向公网访问的UDP包，然后记录NAT规则。路由规则是双向的，于是建立了UDP的双向连接。

于是zerotier的场景如下：

1. A和B都在局域网内，S在公网上（作为服务器）。A和B定期向S发送UDP包，S会记录A和B的存在，并且拿到A和B的公网IP端口。
2. 如果A想和B说话，那么A会先从S处获取B的地址，然后S会给A和B分别发送对方的地址（IP和端口）。
3. A和B同时给对方发信息，A的NAT路由器看到一条消息离开A以获取B的公共IP和端口，而B的NAT路由器在A的方向看到同样的事情。如上所述，两个NAT路由器都创建了一个映射条目。然后，每个NAT路由器将另一方的包解释为双向UDP“连接”中的回复，并同样解释更多的数据包。只要A和B足够频繁地相互发送保持活动消息（对于典型路由器来说大约每 120 秒），这种对话就可以无限期地继续下去。

于是，NAT让P2P连接变得可能；至于维持这种P2P连接的开销，消息体并不大，一个云服务器就可以给最多百万级的设备提供NAT穿透；最后，方法不优雅但是可以用。

此外，如果A和B试图传输消息，S也可以作为中继节点。

## NAT的类型

在Zerotier的博客中，还提到了NAT的类型：

* 锥形NAT：只要内部网络的一个IP地址和端口号与映射规则匹配，该数据包就可以通过NAT转发到外部网络。
* 地址受限的锥形NAT：IP限制圆锥型NAT是指同一个内网IP1+Port1向任何外网发送数据，在NAT会被映射到同一个外网的IP2+Port2；但是这种地址映射是与外网目的主机IP关联的，也就是说当内网IP1+Port1没有主动向IP3的外网主机发送数据，那么IP3的主机向IP2+Port2发送数据，将会被NAT丢弃。两台内网设备需要互相给对方发送一个报文，才能打洞成功。
* 端口受限的锥形NAT：Port限制圆锥型NAT是指同一个内网IP1+Port1向任何外网发送数据，在NAT会被映射到同一个外网的IP2+Port2；但是这种地址映射是与外网目的主机IP和端口关联的，也就是说当内网IP1+Port1没有主动向IP3的外网主机的Port3发送数据，那么IP3+Port3向IP2+Port2发送数据，将会被NAT丢弃。
* 对称的NAT：对称型NAT是内网IP1+Port1向外网IP2+Port2发送数据时，在NAT会被映射到一个外网的IP3+Port3；当向外网IP4+Port4发送数据时，在NAT会被映射到一个外网的IP5+Port5。对称 NAT，会同时根据内网设备出方向报文的源 IP、源端口号、目的 IP、目的端口号四个信息来建立 NAT 表项。如果报文的目的 IP、目的端口号发生了变化，映射到的外部端口号也会发生改变。

对于前三种NAT，zerotier是可以打洞的。对于第四种，如果双方中有一方是锥型NAT，那其实也能打，但是如果双方都是对称的NAT，因为IP地址一直在跳来跳去，洞就不好打了。

对于两方都是对称NAT的情形，ZeroTier在未来将引入一种取巧的方法：因为很多对称NAT选择端口都是顺序选择，因此可以尝试端口号+1和端口号+2。但是这种情况一般碰不到。

## 当主机在同一个网络下

如果两个peer都在一个内网下，进而在一个NAT后面。打洞是可以打的，但是他们都需要连接到公网，因此性能会比内网直连要差。

ZeroTier的做法是UDP广播。每过60秒就向子网里广播一个包，告诉所有人我是谁。出于某种原因，最后zerotier他们没用这个方案，详见参考文献。

## UPnP和其他的“标准”

非常不幸, zerotier不支持. 

一些 NAT 设备支持从内部有意打开端口的各种方法。其中最常见的称为通用即插即用（UPnP）。ZeroTier 不支持它，因为它通常只在家庭路由器等小型路由器设备中找到。这些通常实现某种形式的 “全锥” NAT，可以使用普通打孔来遍历，因此我们的用例不需要 UPnP。它最终可能会得到支持，因为该规则肯定会有一些例外，目标是在尽可能多的场景中支持遍历。UPnP 是一个相当丑陋的半标准。它不太可能得到比现在更广泛的支持。

## NAT害死猫

NAT其实是一个很操蛋的事情。它操蛋的地方在于，NAT需要做的一些类似于端口保活的东西（120秒/次），这个事情对于用电池的小设备来说开销很大，类似的事情也会引入一些安全问题。根本原因是IPV4的地址数量有限。所以，用IPv6的日子，才是好日子！

## References

https://www.xiaoxk.com/4-kinds-of-nat

https://www.zerotier.com/blog/the-state-of-nat-traversal/